#!/usr/bin/env bash
selectedNode=$1
imageName=$2
imageTag=$3

if [[ -f Dockerfile.external ]] ; then extension=".external"; fi
if [[ -f Dockerfile${extension} ]] ; then

  export VCW_TAG="$imageTag"
  export VCW_TAG_BASH="5.0.18"

  tmpfile=$(mktemp /tmp/Dockerfile${extension}.XXXXXX)
  cat  Dockerfile${extension} | envsubst > tmpfile
#  executionplane "--errors-only" docker build -t $imageName -f tmpfile .
#  executionplane docker buildx build --platform linux/amd64,linux/arm64,linux/arm/v7 --push -t registry.vcweb.iot/buildx/hello2 .
  executionplane docker build -t $imageName -f tmpfile .
  rm tmpfile

  executionplane docker tag ${imageName} ${imageName}:${imageTag}
  if [[ "${VCW_REGISTRY}" != "" ]] ; then
    executionplane docker tag ${imageName} ${VCW_REGISTRY}$imageName
    executionplane docker tag ${imageName} ${VCW_REGISTRY}${imageName}:${imageTag}
  fi

else executionplane-error "${selectedNode}/Dockerfile${extension}: File does not exist."; fi
